import { Component, Input, Output, ViewChild, EventEmitter } from '@angular/core';
export class NgMagnizoomComponent {
    constructor() {
        this.zoomMode = 'COVER';
        this.minZoomFactor = 1.2;
        this.maxZoomFactor = 3;
        this.zoomFactor = 2;
        this.zoomFactorChange = new EventEmitter();
        this.lensSizeUnit = 'NORMALIZED';
        this.lensSize = { width: 0.5, height: 0.5 };
        this.zoomCenterUnit = 'NORMALIZED';
        this.zoomCenterChange = new EventEmitter();
        this.updateOnMouseEvents = true;
        this.imageReady = false;
    }
    get canvasWidth() { return this.image && this.image.width || 800; }
    get canvasHeight() { return this.image && this.image.height || 600; }
    ngOnInit() {
        this.initContext();
        this.loadImage(this.imageSrc);
    }
    ngOnChanges(changes) {
        if (!changes) {
            return;
        }
        if (changes.lensSize || changes.zoomCenter || changes.zoomFactor) {
            this.updateParameters();
        }
        if (changes.imageSrc && !changes.imageSrc.firstChange) {
            this.loadImage(changes.imageSrc.currentValue);
        }
    }
    initContext() {
        this.canvas = this.mainCanvasRef.nativeElement;
        this.context = this.canvas.getContext('2d');
    }
    loadImage(src) {
        this.image = new Image();
        this.image.onload = () => {
            this.imageReady = true;
            this.updateParameters();
            setTimeout(() => this.update());
        };
        this.image.src = src;
    }
    updateParameters() {
        if (this.lensSizeUnit === 'NORMALIZED') {
            if (this.imageReady) {
                this._lensSize = {
                    width: this.lensSize.width * this.image.width,
                    height: this.lensSize.height * this.image.height
                };
            }
        }
        else {
            this._lensSize = {
                width: this.lensSize.width,
                height: this.lensSize.height
            };
        }
        if (!this.zoomCenter) {
            this._centerPosition = undefined;
        }
        else if (this.zoomCenterUnit === 'NORMALIZED') {
            if (this.imageReady) {
                this._centerPosition = {
                    x: this.zoomCenter.x * this.image.width,
                    y: this.zoomCenter.y * this.image.height
                };
            }
        }
        else {
            this._centerPosition = {
                x: this.zoomCenter.x,
                y: this.zoomCenter.y
            };
        }
        this._zoomFactor = this.zoomFactor;
        if (this._zoomFactor > this.maxZoomFactor) {
            this._zoomFactor = this.maxZoomFactor;
        }
        if (this._zoomFactor < this.minZoomFactor) {
            this._zoomFactor = this.minZoomFactor;
        }
        this.update();
    }
    update() {
        var _a, _b, _c, _d;
        this.render();
        let currUnitCenter, needUpdate = false;
        if (!this._centerPosition) {
            currUnitCenter = undefined;
            needUpdate = currUnitCenter !== this.zoomCenter;
        }
        else if (this.zoomCenterUnit === 'NORMALIZED') {
            if (this.imageReady) {
                currUnitCenter = {
                    x: this._centerPosition.x / this.image.width,
                    y: this._centerPosition.y / this.image.height
                };
                needUpdate = currUnitCenter.x !== ((_a = this.zoomCenter) === null || _a === void 0 ? void 0 : _a.x) || currUnitCenter.y !== ((_b = this.zoomCenter) === null || _b === void 0 ? void 0 : _b.y);
            }
        }
        else {
            currUnitCenter = {
                x: this._centerPosition.x,
                y: this._centerPosition.y
            };
            needUpdate = currUnitCenter.x !== ((_c = this.zoomCenter) === null || _c === void 0 ? void 0 : _c.x) || currUnitCenter.y !== ((_d = this.zoomCenter) === null || _d === void 0 ? void 0 : _d.y);
        }
        if (needUpdate) {
            this.zoomCenterChange.emit(currUnitCenter);
        }
    }
    render() {
        if (!this.context || !this.imageReady) {
            return;
        }
        this.context.clearRect(0, 0, this.canvasWidth, this.canvasHeight); // clear canvas
        this.context.lineWidth = 1; // border width
        this.context.drawImage(this.image, 0, 0); // bg image
        if (this._centerPosition) {
            switch (this.zoomMode) {
                case 'LENS':
                    this.renderLensMode();
                    break;
                case 'COVER':
                    this.renderCoverMode();
                    break;
            }
        }
    }
    renderLensMode() {
        this.context.lineWidth = 5; // border width
        const zoomRect = this.getZoomRect();
        this.context.fillRect(zoomRect.x, zoomRect.y, zoomRect.w, zoomRect.h); // bg (clear)
        const clippingRect = this.getClippingRect();
        // zoom image
        this.context.drawImage(this.image, clippingRect.x, clippingRect.y, clippingRect.w, clippingRect.h, zoomRect.x, zoomRect.y, zoomRect.w, zoomRect.h);
        this.context.strokeRect(zoomRect.x, zoomRect.y, zoomRect.w, zoomRect.h); // border
    }
    renderCoverMode() {
        const covertRect = this.getCoverRect();
        this.context.drawImage(this.image, covertRect.x, covertRect.y, covertRect.w, covertRect.h, 0, 0, this.canvasWidth, this.canvasHeight); // cover image
    }
    getZoomRect() {
        const w = this._lensSize.width;
        const h = this._lensSize.height;
        const x = this._centerPosition.x - (w / 2);
        const y = this._centerPosition.y - (h / 2);
        return this.clampRect(x, y, w, h);
    }
    getClippingRect() {
        const w = this._lensSize.width / this._zoomFactor;
        const h = this._lensSize.height / this._zoomFactor;
        const x = this._centerPosition.x - (w / 2);
        const y = this._centerPosition.y - (h / 2);
        return this.clampRect(x, y, w, h);
    }
    getCoverRect() {
        const w = this.canvasWidth / this._zoomFactor;
        const h = this.canvasHeight / this._zoomFactor;
        // const x = this.mousePosition.x - (w / 2);
        // const y = this.mousePosition.y - (h / 2);
        const x = this._centerPosition.x - this._centerPosition.x / this._zoomFactor;
        const y = this._centerPosition.y - this._centerPosition.y / this._zoomFactor;
        return this.clampRect(x, y, w, h);
    }
    clampRect(x, y, w, h) {
        if (x <= 0) {
            x = 0;
        }
        if (x + w >= this.canvasWidth) {
            x = this.canvasWidth - w;
        }
        if (y < 0) {
            y = 0;
        }
        if (y + h >= this.canvasHeight) {
            y = this.canvasHeight - h;
        }
        return { x, y, w, h };
    }
    calculateMousePosition(clientX, clientY) {
        const boundingRect = this.canvas.getBoundingClientRect();
        const viewToModelX = this.canvasWidth / boundingRect.width;
        const viewToModelY = this.canvasHeight / boundingRect.height;
        const x = (clientX - boundingRect.left) * viewToModelX;
        const y = (clientY - boundingRect.top) * viewToModelY;
        this._centerPosition = { x, y };
    }
    onMouseLeave(event) {
        if (!this.updateOnMouseEvents) {
            return;
        }
        this._centerPosition = null;
        this.update();
    }
    onMouseEnterOrMove(event) {
        if (!this.updateOnMouseEvents) {
            return;
        }
        this.calculateMousePosition(event.clientX, event.clientY);
        this.update();
    }
    onMouseScroll(event) {
        if (!this.updateOnMouseEvents) {
            return;
        }
        let newZoomFactor = this._zoomFactor;
        newZoomFactor -= event.deltaY / 1000;
        if (newZoomFactor < this.minZoomFactor) {
            newZoomFactor = this.minZoomFactor;
        }
        if (newZoomFactor > this.maxZoomFactor) {
            newZoomFactor = this.maxZoomFactor;
        }
        if (this._zoomFactor !== newZoomFactor) {
            this._zoomFactor = newZoomFactor;
            if (this.zoomFactor !== this._zoomFactor) {
                this.zoomFactorChange.emit(this._zoomFactor);
            }
            this.update();
        }
        event.preventDefault();
        event.stopPropagation();
    }
}
NgMagnizoomComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-magnizoom',
                template: "<canvas #mainCanvas\n  class=\"main-canvas\"\n  [ngClass]=\"imageClass\"\n  [ngStyle]=\"imageStyle\"\n  [width]=\"canvasWidth\"\n  [height]=\"canvasHeight\"\n  (mouseleave)=\"onMouseLeave($event)\"\n  (mouseenter)=\"onMouseEnterOrMove($event)\"\n  (mousemove)=\"onMouseEnterOrMove($event)\"\n  (wheel)=\"onMouseScroll($event)\">\n</canvas>\n",
                styles: [""]
            },] }
];
/** @nocollapse */
NgMagnizoomComponent.ctorParameters = () => [];
NgMagnizoomComponent.propDecorators = {
    imageSrc: [{ type: Input }],
    zoomMode: [{ type: Input }],
    minZoomFactor: [{ type: Input }],
    maxZoomFactor: [{ type: Input }],
    zoomFactor: [{ type: Input }],
    zoomFactorChange: [{ type: Output }],
    lensSizeUnit: [{ type: Input }],
    lensSize: [{ type: Input }],
    zoomCenterUnit: [{ type: Input }],
    zoomCenter: [{ type: Input }],
    zoomCenterChange: [{ type: Output }],
    updateOnMouseEvents: [{ type: Input }],
    imageStyle: [{ type: Input }],
    imageClass: [{ type: Input }],
    mainCanvasRef: [{ type: ViewChild, args: ['mainCanvas', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFnbml6b29tLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nLW1hZ25pem9vbS9zcmMvbGliL21hZ25pem9vbS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBb0MsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBVXBILE1BQU0sT0FBTyxvQkFBb0I7SUFzQy9CO1FBbkNTLGFBQVEsR0FBcUIsT0FBTyxDQUFDO1FBQ3JDLGtCQUFhLEdBQUcsR0FBRyxDQUFDO1FBQ3BCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBRWxCLGVBQVUsR0FBRyxDQUFDLENBQUM7UUFDZCxxQkFBZ0IsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBRS9DLGlCQUFZLEdBQTJCLFlBQVksQ0FBQztRQUNwRCxhQUFRLEdBQVcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUUvQyxtQkFBYyxHQUEyQixZQUFZLENBQUM7UUFFckQscUJBQWdCLEdBQUcsSUFBSSxZQUFZLEVBQXVCLENBQUM7UUFHNUQsd0JBQW1CLEdBQUcsSUFBSSxDQUFDO1FBZ0JwQyxlQUFVLEdBQUcsS0FBSyxDQUFDO0lBSUgsQ0FBQztJQUhqQixJQUFJLFdBQVcsS0FBSyxPQUFPLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuRSxJQUFJLFlBQVksS0FBSyxPQUFPLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztJQUlyRSxRQUFRO1FBQ04sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxTQUFTLENB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QyxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDeEMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDOUM7WUFDRCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDZjtRQUNELEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDMUIsQ0FBQzs7O1lBL1BGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsY0FBYztnQkFDeEIsaVdBQXlDOzthQUUxQzs7Ozs7dUJBR0UsS0FBSzt1QkFDTCxLQUFLOzRCQUNMLEtBQUs7NEJBQ0wsS0FBSzt5QkFFTCxLQUFLOytCQUNMLE1BQU07MkJBRU4sS0FBSzt1QkFDTCxLQUFLOzZCQUVMLEtBQUs7eUJBQ0wsS0FBSzsrQkFDTCxNQUFNO2tDQUdOLEtBQUs7eUJBR0wsS0FBSzt5QkFDTCxLQUFLOzRCQUVMLFNBQVMsU0FBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBJbnB1dCwgT3V0cHV0LCBWaWV3Q2hpbGQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbnRlcmZhY2UgU2l6ZTJEIHsgd2lkdGg6IG51bWJlcjsgaGVpZ2h0OiBudW1iZXI7IH1cbnR5cGUgUG9pbnQyRCA9IHsgeDogbnVtYmVyLCB5OiBudW1iZXIgfSB8IG51bGw7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25nLW1hZ25pem9vbScsXG4gIHRlbXBsYXRlVXJsOiAnLi9tYWduaXpvb20uY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9tYWduaXpvb20uY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBOZ01hZ25pem9vbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuICBASW5wdXQoKSBpbWFnZVNyYzogc3RyaW5nO1xuICBASW5wdXQoKSB6b29tTW9kZTogJ0xFTlMnIHwgJ0NPVkVSJyA9ICdDT1ZFUic7XG4gIEBJbnB1dCgpIG1pblpvb21GYWN0b3IgPSAxLjI7XG4gIEBJbnB1dCgpIG1heFpvb21GYWN0b3IgPSAzO1xuXG4gIEBJbnB1dCgpIHpvb21GYWN0b3IgPSAyO1xuICBAT3V0cHV0KCkgem9vbUZhY3RvckNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xuXG4gIEBJbnB1dCgpIGxlbnNTaXplVW5pdDogJ05PUk1BTElaRUQnIHwgJ1BJWEVMJyA9ICdOT1JNQUxJWkVEJztcbiAgQElucHV0KCkgbGVuc1NpemU6IFNpemUyRCA9IHsgd2lkdGg6IDAuNSwgaGVpZ2h0OiAwLjUgfTtcblxuICBASW5wdXQoKSB6b29tQ2VudGVyVW5pdDogJ05PUk1BTElaRUQnIHwgJ1BJWEVMJyA9ICdOT1JNQUxJWkVEJztcbiAgQElucHV0KCkgem9vbUNlbnRlcj86IFBvaW50MkQ7XG4gIEBPdXRwdXQoKSB6b29tQ2VudGVyQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxQb2ludDJEIHwgdW5kZWZpbmVkPigpO1xuXG5cbiAgQElucHV0KCkgdXBkYXRlT25Nb3VzZUV2ZW50cyA9IHRydWU7XG5cblxuICBASW5wdXQoKSBpbWFnZVN0eWxlOiB7IFt4OiBzdHJpbmddOiBhbnk7IH07XG4gIEBJbnB1dCgpIGltYWdlQ2xhc3M6IGFueTtcblxuICBAVmlld0NoaWxkKCdtYWluQ2FudmFzJywgeyBzdGF0aWM6IHRydWUgfSkgbWFpbkNhbnZhc1JlZjogRWxlbWVudFJlZjtcblxuICBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xuICBjb250ZXh0OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG4gIGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50O1xuXG4gIF9jZW50ZXJQb3NpdGlvbjogUG9pbnQyRDtcbiAgX2xlbnNTaXplPzogU2l6ZTJEO1xuICBfem9vbUZhY3RvcjogbnVtYmVyO1xuXG4gIGltYWdlUmVhZHkgPSBmYWxzZTtcbiAgZ2V0IGNhbnZhc1dpZHRoKCkgeyByZXR1cm4gdGhpcy5pbWFnZSAmJiB0aGlzLmltYWdlLndpZHRoIHx8IDgwMDsgfVxuICBnZXQgY2FudmFzSGVpZ2h0KCkgeyByZXR1cm4gdGhpcy5pbWFnZSAmJiB0aGlzLmltYWdlLmhlaWdodCB8fCA2MDA7IH1cblxuICBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5pdENvbnRleHQoKTtcbiAgICB0aGlzLmxvYWRJbWFnZSh0aGlzLmltYWdlU3JjKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoIWNoYW5nZXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXMubGVuc1NpemUgfHwgY2hhbmdlcy56b29tQ2VudGVyIHx8IGNoYW5nZXMuem9vbUZhY3Rvcikge1xuICAgICAgdGhpcy51cGRhdGVQYXJhbWV0ZXJzKCk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmltYWdlU3JjICYmICFjaGFuZ2VzLmltYWdlU3JjLmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLmxvYWRJbWFnZShjaGFuZ2VzLmltYWdlU3JjLmN1cnJlbnRWYWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgaW5pdENvbnRleHQoKSB7XG4gICAgdGhpcy5jYW52YXMgPSAodGhpcy5tYWluQ2FudmFzUmVmLm5hdGl2ZUVsZW1lbnQgYXMgSFRNTENhbnZhc0VsZW1lbnQpO1xuICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gIH1cblxuICBsb2FkSW1hZ2Uoc3JjOiBzdHJpbmcpIHtcbiAgICB0aGlzLmltYWdlID0gbmV3IEltYWdlKCk7XG4gICAgdGhpcy5pbWFnZS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICB0aGlzLmltYWdlUmVhZHkgPSB0cnVlO1xuICAgICAgdGhpcy51cGRhdGVQYXJhbWV0ZXJzKCk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlKCkpO1xuICAgIH07XG4gICAgdGhpcy5pbWFnZS5zcmMgPSBzcmM7XG4gIH1cblxuICB1cGRhdGVQYXJhbWV0ZXJzKCkge1xuICAgIGlmICh0aGlzLmxlbnNTaXplVW5pdCA9PT0gJ05PUk1BTElaRUQnKSB7XG4gICAgICBpZiAodGhpcy5pbWFnZVJlYWR5KSB7XG4gICAgICAgIHRoaXMuX2xlbnNTaXplID0ge1xuICAgICAgICAgIHdpZHRoOiB0aGlzLmxlbnNTaXplLndpZHRoICogdGhpcy5pbWFnZS53aWR0aCxcbiAgICAgICAgICBoZWlnaHQ6IHRoaXMubGVuc1NpemUuaGVpZ2h0ICogdGhpcy5pbWFnZS5oZWlnaHRcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbGVuc1NpemUgPSB7XG4gICAgICAgIHdpZHRoOiB0aGlzLmxlbnNTaXplLndpZHRoLFxuICAgICAgICBoZWlnaHQ6IHRoaXMubGVuc1NpemUuaGVpZ2h0XG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmICghdGhpcy56b29tQ2VudGVyKSB7XG4gICAgICB0aGlzLl9jZW50ZXJQb3NpdGlvbiA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2UgaWYgKHRoaXMuem9vbUNlbnRlclVuaXQgPT09ICdOT1JNQUxJWkVEJyl7XG4gICAgICBpZiAodGhpcy5pbWFnZVJlYWR5KSB7XG4gICAgICAgIHRoaXMuX2NlbnRlclBvc2l0aW9uID0ge1xuICAgICAgICAgIHg6IHRoaXMuem9vbUNlbnRlci54ICogdGhpcy5pbWFnZS53aWR0aCxcbiAgICAgICAgICB5OiB0aGlzLnpvb21DZW50ZXIueSAqIHRoaXMuaW1hZ2UuaGVpZ2h0XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NlbnRlclBvc2l0aW9uID0ge1xuICAgICAgICB4OiB0aGlzLnpvb21DZW50ZXIueCxcbiAgICAgICAgeTogdGhpcy56b29tQ2VudGVyLnlcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdGhpcy5fem9vbUZhY3RvciA9IHRoaXMuem9vbUZhY3RvcjtcbiAgICBpZiAodGhpcy5fem9vbUZhY3RvciA+IHRoaXMubWF4Wm9vbUZhY3Rvcikge1xuICAgICAgdGhpcy5fem9vbUZhY3RvciA9IHRoaXMubWF4Wm9vbUZhY3RvcjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3pvb21GYWN0b3IgPCB0aGlzLm1pblpvb21GYWN0b3IpIHtcbiAgICAgIHRoaXMuX3pvb21GYWN0b3IgPSB0aGlzLm1pblpvb21GYWN0b3I7XG4gICAgfVxuXG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIHVwZGF0ZSgpIHtcbiAgICB0aGlzLnJlbmRlcigpO1xuICAgIGxldCBjdXJyVW5pdENlbnRlcjogeyB4OiBudW1iZXIsIHk6IG51bWJlciB9IHwgdW5kZWZpbmVkLCBuZWVkVXBkYXRlID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLl9jZW50ZXJQb3NpdGlvbikge1xuICAgICAgY3VyclVuaXRDZW50ZXIgPSB1bmRlZmluZWQ7XG4gICAgICBuZWVkVXBkYXRlID0gY3VyclVuaXRDZW50ZXIgIT09IHRoaXMuem9vbUNlbnRlcjtcbiAgICB9IGVsc2UgaWYgKHRoaXMuem9vbUNlbnRlclVuaXQgPT09ICdOT1JNQUxJWkVEJykge1xuICAgICAgaWYgKHRoaXMuaW1hZ2VSZWFkeSkge1xuICAgICAgICBjdXJyVW5pdENlbnRlciA9IHtcbiAgICAgICAgICB4OiB0aGlzLl9jZW50ZXJQb3NpdGlvbi54IC8gdGhpcy5pbWFnZS53aWR0aCxcbiAgICAgICAgICB5OiB0aGlzLl9jZW50ZXJQb3NpdGlvbi55IC8gdGhpcy5pbWFnZS5oZWlnaHRcbiAgICAgICAgfTtcbiAgICAgICAgbmVlZFVwZGF0ZSA9IGN1cnJVbml0Q2VudGVyLnggIT09IHRoaXMuem9vbUNlbnRlcj8ueCB8fCBjdXJyVW5pdENlbnRlci55ICE9PSB0aGlzLnpvb21DZW50ZXI/Lnk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJVbml0Q2VudGVyID0ge1xuICAgICAgICB4OiB0aGlzLl9jZW50ZXJQb3NpdGlvbi54LFxuICAgICAgICB5OiB0aGlzLl9jZW50ZXJQb3NpdGlvbi55XG4gICAgICB9O1xuICAgICAgbmVlZFVwZGF0ZSA9IGN1cnJVbml0Q2VudGVyLnggIT09IHRoaXMuem9vbUNlbnRlcj8ueCB8fCBjdXJyVW5pdENlbnRlci55ICE9PSB0aGlzLnpvb21DZW50ZXI/Lnk7XG4gICAgfVxuICAgIGlmIChuZWVkVXBkYXRlKSB7XG4gICAgICB0aGlzLnpvb21DZW50ZXJDaGFuZ2UuZW1pdChjdXJyVW5pdENlbnRlcik7XG4gICAgfVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGlmICghdGhpcy5jb250ZXh0IHx8ICF0aGlzLmltYWdlUmVhZHkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzV2lkdGgsIHRoaXMuY2FudmFzSGVpZ2h0KTsgLy8gY2xlYXIgY2FudmFzXG4gICAgdGhpcy5jb250ZXh0LmxpbmVXaWR0aCA9IDE7IC8vIGJvcmRlciB3aWR0aFxuICAgIHRoaXMuY29udGV4dC5kcmF3SW1hZ2UodGhpcy5pbWFnZSwgMCwgMCk7IC8vIGJnIGltYWdlXG5cbiAgICBpZiAodGhpcy5fY2VudGVyUG9zaXRpb24pIHtcbiAgICAgIHN3aXRjaCAodGhpcy56b29tTW9kZSkge1xuICAgICAgICBjYXNlICdMRU5TJzogdGhpcy5yZW5kZXJMZW5zTW9kZSgpOyBicmVhaztcbiAgICAgICAgY2FzZSAnQ09WRVInOiB0aGlzLnJlbmRlckNvdmVyTW9kZSgpOyBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZW5kZXJMZW5zTW9kZSgpIHtcbiAgICB0aGlzLmNvbnRleHQubGluZVdpZHRoID0gNTsgLy8gYm9yZGVyIHdpZHRoXG4gICAgY29uc3Qgem9vbVJlY3QgPSB0aGlzLmdldFpvb21SZWN0KCk7XG4gICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHpvb21SZWN0LngsIHpvb21SZWN0LnksIHpvb21SZWN0LncsIHpvb21SZWN0LmgpOyAvLyBiZyAoY2xlYXIpXG4gICAgY29uc3QgY2xpcHBpbmdSZWN0ID0gdGhpcy5nZXRDbGlwcGluZ1JlY3QoKTtcbiAgICAvLyB6b29tIGltYWdlXG4gICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZShcbiAgICAgIHRoaXMuaW1hZ2UsXG4gICAgICBjbGlwcGluZ1JlY3QueCwgY2xpcHBpbmdSZWN0LnksIGNsaXBwaW5nUmVjdC53LCBjbGlwcGluZ1JlY3QuaCxcbiAgICAgIHpvb21SZWN0LngsIHpvb21SZWN0LnksIHpvb21SZWN0LncsIHpvb21SZWN0LmhcbiAgICApO1xuICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHpvb21SZWN0LngsIHpvb21SZWN0LnksIHpvb21SZWN0LncsIHpvb21SZWN0LmgpOyAvLyBib3JkZXJcbiAgfVxuXG4gIHJlbmRlckNvdmVyTW9kZSgpIHtcbiAgICBjb25zdCBjb3ZlcnRSZWN0ID0gdGhpcy5nZXRDb3ZlclJlY3QoKTtcbiAgICB0aGlzLmNvbnRleHQuZHJhd0ltYWdlKFxuICAgICAgdGhpcy5pbWFnZSxcbiAgICAgIGNvdmVydFJlY3QueCwgY292ZXJ0UmVjdC55LCBjb3ZlcnRSZWN0LncsIGNvdmVydFJlY3QuaCxcbiAgICAgIDAsIDAsIHRoaXMuY2FudmFzV2lkdGgsIHRoaXMuY2FudmFzSGVpZ2h0XG4gICAgKTsgLy8gY292ZXIgaW1hZ2VcbiAgfVxuXG4gIGdldFpvb21SZWN0KCkge1xuICAgIGNvbnN0IHcgPSB0aGlzLl9sZW5zU2l6ZS53aWR0aDtcbiAgICBjb25zdCBoID0gdGhpcy5fbGVuc1NpemUuaGVpZ2h0O1xuICAgIGNvbnN0IHggPSB0aGlzLl9jZW50ZXJQb3NpdGlvbi54IC0gKHcgLyAyKTtcbiAgICBjb25zdCB5ID0gdGhpcy5fY2VudGVyUG9zaXRpb24ueSAtIChoIC8gMik7XG4gICAgcmV0dXJuIHRoaXMuY2xhbXBSZWN0KHgsIHksIHcsIGgpO1xuICB9XG5cbiAgZ2V0Q2xpcHBpbmdSZWN0KCkge1xuICAgIGNvbnN0IHcgPSB0aGlzLl9sZW5zU2l6ZS53aWR0aCAvIHRoaXMuX3pvb21GYWN0b3I7XG4gICAgY29uc3QgaCA9IHRoaXMuX2xlbnNTaXplLmhlaWdodCAvIHRoaXMuX3pvb21GYWN0b3I7XG4gICAgY29uc3QgeCA9IHRoaXMuX2NlbnRlclBvc2l0aW9uLnggLSAodyAvIDIpO1xuICAgIGNvbnN0IHkgPSB0aGlzLl9jZW50ZXJQb3NpdGlvbi55IC0gKGggLyAyKTtcbiAgICByZXR1cm4gdGhpcy5jbGFtcFJlY3QoeCwgeSwgdywgaCk7XG4gIH1cblxuICBnZXRDb3ZlclJlY3QoKSB7XG4gICAgY29uc3QgdyA9IHRoaXMuY2FudmFzV2lkdGggLyB0aGlzLl96b29tRmFjdG9yO1xuICAgIGNvbnN0IGggPSB0aGlzLmNhbnZhc0hlaWdodCAvIHRoaXMuX3pvb21GYWN0b3I7XG4gICAgLy8gY29uc3QgeCA9IHRoaXMubW91c2VQb3NpdGlvbi54IC0gKHcgLyAyKTtcbiAgICAvLyBjb25zdCB5ID0gdGhpcy5tb3VzZVBvc2l0aW9uLnkgLSAoaCAvIDIpO1xuICAgIGNvbnN0IHggPSB0aGlzLl9jZW50ZXJQb3NpdGlvbi54IC0gdGhpcy5fY2VudGVyUG9zaXRpb24ueCAvIHRoaXMuX3pvb21GYWN0b3I7XG4gICAgY29uc3QgeSA9IHRoaXMuX2NlbnRlclBvc2l0aW9uLnkgLSB0aGlzLl9jZW50ZXJQb3NpdGlvbi55IC8gdGhpcy5fem9vbUZhY3RvcjtcbiAgICByZXR1cm4gdGhpcy5jbGFtcFJlY3QoeCwgeSwgdywgaCk7XG4gIH1cblxuICBjbGFtcFJlY3QoeDogbnVtYmVyLCB5OiBudW1iZXIsIHc6IG51bWJlciwgaDogbnVtYmVyKSB7XG4gICAgaWYgKHggPD0gMCkgeyB4ID0gMDsgfVxuICAgIGlmICh4ICsgdyA+PSB0aGlzLmNhbnZhc1dpZHRoKSB7IHggPSB0aGlzLmNhbnZhc1dpZHRoIC0gdzsgfVxuICAgIGlmICh5IDwgMCkgeyB5ID0gMDsgfVxuICAgIGlmICh5ICsgaCA+PSB0aGlzLmNhbnZhc0hlaWdodCkgeyB5ID0gdGhpcy5jYW52YXNIZWlnaHQgLSBoOyB9XG4gICAgcmV0dXJuIHsgeCwgeSwgdywgaCB9O1xuICB9XG5cbiAgY2FsY3VsYXRlTW91c2VQb3NpdGlvbihjbGllbnRYOiBudW1iZXIsIGNsaWVudFk6IG51bWJlcikge1xuICAgIGNvbnN0IGJvdW5kaW5nUmVjdCA9IHRoaXMuY2FudmFzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGNvbnN0IHZpZXdUb01vZGVsWCA9IHRoaXMuY2FudmFzV2lkdGggLyBib3VuZGluZ1JlY3Qud2lkdGg7XG4gICAgY29uc3Qgdmlld1RvTW9kZWxZID0gdGhpcy5jYW52YXNIZWlnaHQgLyBib3VuZGluZ1JlY3QuaGVpZ2h0O1xuICAgIGNvbnN0IHggPSAoY2xpZW50WCAtIGJvdW5kaW5nUmVjdC5sZWZ0KSAqIHZpZXdUb01vZGVsWDtcbiAgICBjb25zdCB5ID0gKGNsaWVudFkgLSBib3VuZGluZ1JlY3QudG9wKSAqIHZpZXdUb01vZGVsWTtcbiAgICB0aGlzLl9jZW50ZXJQb3NpdGlvbiA9IHsgeCwgeSB9O1xuICB9XG5cbiAgb25Nb3VzZUxlYXZlKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgaWYgKCF0aGlzLnVwZGF0ZU9uTW91c2VFdmVudHMpIHsgcmV0dXJuOyB9XG4gICAgdGhpcy5fY2VudGVyUG9zaXRpb24gPSBudWxsO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICBvbk1vdXNlRW50ZXJPck1vdmUoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICBpZiAoIXRoaXMudXBkYXRlT25Nb3VzZUV2ZW50cykgeyByZXR1cm47IH1cbiAgICB0aGlzLmNhbGN1bGF0ZU1vdXNlUG9zaXRpb24oZXZlbnQuY2xpZW50WCwgZXZlbnQuY2xpZW50WSk7XG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIG9uTW91c2VTY3JvbGwoZXZlbnQ6IFdoZWVsRXZlbnQpIHtcbiAgICBpZiAoIXRoaXMudXBkYXRlT25Nb3VzZUV2ZW50cykgeyByZXR1cm47IH1cbiAgICBsZXQgbmV3Wm9vbUZhY3RvciA9IHRoaXMuX3pvb21GYWN0b3I7XG4gICAgbmV3Wm9vbUZhY3RvciAtPSBldmVudC5kZWx0YVkgLyAxMDAwO1xuICAgIGlmIChuZXdab29tRmFjdG9yIDwgdGhpcy5taW5ab29tRmFjdG9yKSB7IG5ld1pvb21GYWN0b3IgPSB0aGlzLm1pblpvb21GYWN0b3I7IH1cbiAgICBpZiAobmV3Wm9vbUZhY3RvciA+IHRoaXMubWF4Wm9vbUZhY3RvcikgeyBuZXdab29tRmFjdG9yID0gdGhpcy5tYXhab29tRmFjdG9yOyB9XG4gICAgaWYgKHRoaXMuX3pvb21GYWN0b3IgIT09IG5ld1pvb21GYWN0b3IpIHtcbiAgICAgIHRoaXMuX3pvb21GYWN0b3IgPSBuZXdab29tRmFjdG9yO1xuICAgICAgaWYgKHRoaXMuem9vbUZhY3RvciAhPT0gdGhpcy5fem9vbUZhY3Rvcikge1xuICAgICAgICB0aGlzLnpvb21GYWN0b3JDaGFuZ2UuZW1pdCh0aGlzLl96b29tRmFjdG9yKTtcbiAgICAgIH1cbiAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfVxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gIH1cblxuXG59XG4iXX0=